---
version: 3

tasks:
  jsonschema:
    desc: Validation the schema of configuration files in the repository
    summary: |-
      Validate the layout and content of the YAML files in this repository
      using the JSON Schema files, including:

      - Taskfiles (Taskfile.yaml, .taskfiles/*.yaml)
      - GitHub Dependabot configuration (.github/dependabot.yaml)
      - GitHub Workflows (.github/workflows/*.yaml)
      - pre-commit Configuration (.pre-commit-config)
      - Ansible plays (plays/*.yaml)
      - Ansible tasks and meta files (roles/*/{tasks,meta}/*.yaml)
      - Ansible inventory (inventory.yaml)
      - ansible-lint configuration (.ansible-lint.yaml)

      Checks on Kubernetes resources under the flux/ folder will be managed
      through the conform tasks using kubeconform, as although kubeconform still
      uses JSON Schemas, it is able to dynamocally find and process the schemas.

      $ task --summary conform
    silent: true
    deps:
      - task: yamllint
    cmds:
      - task: jsonschema:taskfiles
      - task: jsonschema:dependabot
      - task: jsonschema:workflows
      - task: jsonschema:pre-commit-config
      - task: jsonschema:ansible-lint
      - task: jsonschema:ansible:requirements
      - task: jsonschema:ansible:inventory
      - task: jsonschema:ansible:plays
      - task: jsonschema:ansible:tasks
      - task: jsonschema:ansible:meta

  jsonschema:taskfiles:
    internal: true
    silent: true
    sources:
      - Taskfile.yaml
      - .taskfiles/*.yaml
    cmds:
      - cmd: |-
          check-jsonschema \
            --output-format text --no-cache --verbose \
            --builtin-schema vendor.taskfile \
            Taskfile.yaml .taskfiles/*.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'

  jsonschema:dependabot:
    internal: true
    silent: true
    sources:
      - .github/dependabot.yaml
    cmds:
      - cmd: |-
          [[ -f .github/dependabot.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --builtin-schema vendor.dependabot \
            .github/dependabot.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'

  jsonschema:workflows:
    internal: true
    silent: true
    sources:
      - .github/workflows/*.yaml
    vars:
      files:
        sh: |-
          find .github/workflows \
            -ignore_readdir_race \
            -type f \
            -iname '*.yaml' \
            -printf '.github/workflows/%P ' \
          2>/dev/null || true
    cmds:
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --builtin-schema vendor.github-workflows \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'

  jsonschema:pre-commit-config:
    internal: true
    silent: true
    sources:
      - .pre-commit-config.yaml
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -f .pre-commit-config.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename pre-commit-config.json \
            --schemafile https://raw.githubusercontent.com/SchemaStore/schemastore/master/src/schemas/json/pre-commit-config.json \
            .pre-commit-config.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible-lint:
    internal: true
    silent: true
    sources:
      - .ansible-lint.yaml
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -f .ansible-lint.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename pre-commit-config.json \
            --schemafile https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible-lint-config.json \
            .ansible-lint.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible:
    internal: true
    silent: true
    deps:
      - task: yamllint
    cmds:
      - task: jsonschema:ansible:requirements
      - task: jsonschema:ansible:inventory
      - task: jsonschema:ansible:plays
      - task: jsonschema:ansible:tasks
      - task: jsonschema:ansible:meta

  jsonschema:ansible:requirements:
    internal: true
    silent: true
    sources:
      - requirements.yaml
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -f requirements.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename inventory.json \
            --schemafile https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/requirements.json \
            requirements.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible:inventory:
    internal: true
    silent: true
    sources:
      - inventory.yaml
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -f inventory.yaml ]] || exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename inventory.json \
            --schemafile https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/inventory.json \
            inventory.yaml
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible:plays:
    internal: true
    silent: true
    sources:
      - plays/*.yaml
    vars:
      files:
        sh: |-
          find plays/ \
            -ignore_readdir_race \
            -maxdepth 1 -type f \
            -iname '*.yaml' \
            -printf 'plays/%P ' \
          2>/dev/null || true
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename ansible.json \
            --schemafile 'https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json#/$defs/playbook' \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible:tasks:
    internal: true
    silent: true
    sources:
      - roles/*/tasks/*.yaml
    vars:
      files:
        sh: |-
          find roles/ \
            -ignore_readdir_race \
            -mindepth 3 -type f \
            -path '*/tasks/*' \
            -iname '*.yaml' \
            -printf 'roles/%P ' \
          2>/dev/null || true
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename ansible.json \
            --schemafile 'https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json#/$defs/tasks' \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length

  jsonschema:ansible:meta:
    internal: true
    silent: true
    sources:
      - roles/*/meta/*.yaml
    vars:
      files:
        sh: |-
          find roles/ \
            -ignore_readdir_race \
            -mindepth 3 -type f \
            -path '*/meta/*' \
            -iname '*.yaml' \
            -printf 'roles/%P ' \
          2>/dev/null || true
    cmds:
      # yamllint disable rule:line-length
      - cmd: |-
          [[ -z '{{ .files }}' ]] && exit 0
          check-jsonschema \
            --output-format text --verbose \
            --cache-filename ansible.json \
            --schemafile https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/meta.json \
            {{ .files }}
          echo -e '{{ .cg }}Passed{{ .cc }}'
      # yamllint enable rule:line-length
