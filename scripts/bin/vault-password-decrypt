#!/usr/bin/env bash
set -euo pipefail

# To handle running inside GitHub Workflows, or any other CI-based action,
# allow, if set, this variable to override the decryption of the vault secrets
# and instead output this value as a placeholder for testing the parsing of
# secrets inside ansible-lint
if [[ -n "${ANSIBLE_SCRIPT_VAULT_DECRYPT_OVERRIDE:-}" ]]; then
  echo "${ANSIBLE_SCRIPT_VAULT_DECRYPT_OVERRIDE}"
  exit 0
fi

VAULT_KEY=${VAULT_KEY:-"${HOME}/.ansible/keys/ansible.gpg"}

# Fast exit if the file does not exist
if [[ ! -f "${VAULT_KEY}" ]]; then
  (>&2 echo "FATAL: Unable to find the vault key file (${VAULT_KEY})")
  exit 1
fi

gpg \
  --quiet \
  --batch \
  --use-agent \
  --decrypt \
  "${VAULT_KEY}"
