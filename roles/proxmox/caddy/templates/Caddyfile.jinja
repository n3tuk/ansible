# {{ ansible_managed }}

{{ 'manager' if proxmox_node_type == 'manager' else 'proxmox' }}.{{ ansible_facts.domain }} {
{% if caddy_acme_cloudflare_enabled %}
  tls {
    dns cloudflare {{ caddy_acme_cloudflare_api_token }}
    resolvers {{ caddy_tls_resolvers | join(" ") }}
  }

{% endif %}
  reverse_proxy
{%- for host in groups[env_name] %}
{%-   if proxmox_node_type == 'cluster' %}
{%-     if host in groups['proxmox'] | sort %}
 [{{ hostvars[host].ansible_facts.default_ipv6.address }}]:8006
{%-     endif %}
{%-   else %}
{%-     if host in groups['manager'] | sort %}
 [{{ hostvars[host].ansible_facts.default_ipv6.address }}]:8443
{%-     endif %}
{%-   endif %}
{%- endfor %} {
    transport http {
      # The Proxmox servers currently do not have valid TLS certificates, so
      # skip checks until valid certificates have been created and loaded
      tls_insecure_skip_verify
    }

    # Generally send all traffic to proxmox-01 first, failing over to other
    # nodes in the event the first one is not avilable.
    lb_policy first

    # Configure the health checks against the Proxmox nodes to ensure the first
    # load balancer policy is effective and will fail over to the next node
    health_interval 10s
    health_uri /
    health_status 200
    health_timeout 2s
    health_fails 2
  }
}

{{ ansible_facts.fqdn }} {
{% if caddy_acme_cloudflare_enabled %}
  tls {
    dns cloudflare {{ caddy_acme_cloudflare_api_token }}
    resolvers {{ caddy_tls_resolvers | join(" ") }}
  }

{% endif %}
  reverse_proxy [{{ ansible_facts.default_ipv6.address }}]:{{ '8006' if proxmox_node_type == 'cluster' else '8443' }} {
    transport http {
      tls_insecure_skip_verify
    }
  }
}
